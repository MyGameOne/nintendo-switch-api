# KV 游戏 ID 管理系统需求文档

## 介绍

本文档定义了基于 Cloudflare KV 的智能游戏 ID 队列管理系统的需求。该系统旨在实现用户驱动的游戏数据采集闭环，通过智能去重和队列管理，提高数据采集效率并节省资源成本。

## 需求

### 需求 1：智能队列管理

**用户故事：** 作为 API 系统，我希望能够自动识别缺失的游戏数据，并将相应的游戏 ID 添加到爬取队列中，以便爬虫系统能够及时补充数据。

#### 验收标准

1. WHEN 用户查询游戏记录时 THEN 系统 SHALL 检查每个游戏 ID 是否存在于 D1 数据库中
2. WHEN 发现游戏 ID 不存在于数据库中时 THEN 系统 SHALL 将该 ID 添加到 KV 队列中
3. WHEN 添加游戏 ID 到队列时 THEN 系统 SHALL 记录添加时间戳和来源信息
4. WHEN 游戏 ID 已存在于队列中时 THEN 系统 SHALL 跳过重复添加操作

### 需求 2：去重机制

**用户故事：** 作为系统管理员，我希望系统能够避免重复的爬取工作，以节省计算资源和 API 调用成本。

#### 验收标准

1. WHEN 检查游戏 ID 时 THEN 系统 SHALL 首先查询 KV 队列状态避免重复添加
2. WHEN 检查游戏 ID 时 THEN 系统 SHALL 查询 D1 数据库确认数据是否已存在
3. WHEN 缓存游戏存在性信息时 THEN 系统 SHALL 设置适当的 TTL 以减少重复查询
4. IF 游戏数据已存在 THEN 系统 SHALL 缓存该信息 6 小时以提高性能

### 需求 3：队列状态管理

**用户故事：** 作为开发者，我希望能够查看和管理游戏 ID 队列的状态，以便监控系统运行情况和手动干预。

#### 验收标准

1. WHEN 请求队列统计时 THEN 系统 SHALL 返回待处理游戏数量和部分游戏 ID 列表
2. WHEN 手动添加游戏 ID 时 THEN 系统 SHALL 验证 ID 格式为 16 位十六进制
3. WHEN 手动添加游戏 ID 时 THEN 系统 SHALL 执行去重检查避免重复添加
4. WHEN 添加无效格式的游戏 ID 时 THEN 系统 SHALL 返回明确的错误信息

### 需求 4：数据库字段适配

**用户故事：** 作为 API 用户，我希望能够获取游戏的中文名称和发行商信息，以提供更好的用户体验。

#### 验收标准

1. WHEN 查询游戏增强信息时 THEN 系统 SHALL 使用 formal_name 字段作为中文名称
2. WHEN 查询游戏增强信息时 THEN 系统 SHALL 使用 publisher_name 字段作为发行商信息
3. WHEN 统计有中文名称的游戏时 THEN 系统 SHALL 基于 formal_name 字段进行计算
4. WHEN 返回游戏记录时 THEN 系统 SHALL 将 formal_name 映射到 titleNameCN 字段

### 需求 5：缓存优化

**用户故事：** 作为系统，我希望通过智能缓存减少数据库查询次数，以提高响应速度并节省资源成本。

#### 验收标准

1. WHEN 检查游戏存在性时 THEN 系统 SHALL 首先查询缓存避免重复数据库查询
2. WHEN 缓存游戏存在性信息时 THEN 系统 SHALL 设置 6 小时的 TTL
3. WHEN 批量处理游戏 ID 时 THEN 系统 SHALL 使用批量缓存操作提高效率
4. WHEN 缓存未命中时 THEN 系统 SHALL 查询数据库并更新缓存

### 需求 6：统计信息增强

**用户故事：** 作为系统监控者，我希望能够获取包含队列信息的系统统计数据，以便了解系统运行状态。

#### 验收标准

1. WHEN 请求系统统计时 THEN 系统 SHALL 返回总游戏数量和有中文名称的游戏数量
2. WHEN 请求系统统计时 THEN 系统 SHALL 返回当前队列中待处理的游戏数量
3. WHEN 请求系统统计时 THEN 系统 SHALL 计算中文名称覆盖率百分比
4. WHEN 统计信息查询失败时 THEN 系统 SHALL 返回默认值而不是错误

### 需求 7：管理接口

**用户故事：** 作为系统管理员，我希望有专门的管理接口来监控和操作游戏 ID 队列。

#### 验收标准

1. WHEN 访问队列统计接口时 THEN 系统 SHALL 返回待处理数量和部分游戏 ID 列表
2. WHEN 手动添加游戏 ID 时 THEN 系统 SHALL 支持单个或批量添加操作
3. WHEN 添加游戏 ID 成功时 THEN 系统 SHALL 返回实际添加的 ID 列表
4. WHEN 请求方法不正确时 THEN 系统 SHALL 返回 405 状态码和错误信息
